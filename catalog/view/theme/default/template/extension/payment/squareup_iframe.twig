{% if sandbox_message %}
<div class="alert alert-warning">
  <span class="fa fa-exclamation-circle"></span>&nbsp;{{ sandbox_message }}
</div>
{% endif %}

<!-- container for the Square card form which will be in an iframe -->
<div id="card-container"></div>

<button id="card-button" type="button" class="btn btn-primary">{{ text_payment }}</button>

{% if is_sandbox %}
<script type="text/javascript" src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
{% else %}
<script type="text/javascript" src="https://web.squarecdn.com/v1/square.js"></script>
{% endif %}

<script type="text/javascript">
(function() {
    async function initializeSquare() {
        console.log("Attempting to initialize Square...");
        
        try {
            const payments = Square.payments('{{ application_id }}', '{{ location_id }}');
            const card = await payments.card();
            await card.attach('#card-container');

            document.getElementById('card-button').addEventListener('click', async (event) => {
                event.preventDefault();  // Prevent OpenCart from submitting the form early
                event.stopPropagation(); // Stop event from bubbling up to other handlers
                event.stopImmediatePropagation(); // Prevent other OpenCart listeners on this same button

                // Optional: Disable the button to prevent double-clicks
                const btn = event.currentTarget;
                btn.disabled = true;
                
                try {

                    // 1. Tokenize the card first to get the source ID (cnon)
                    const result = await card.tokenize();

                    if (result.status === 'OK') {
                        console.log('Source ID:', result.token);

                        // 2. Perform verification
                        const verificationDetails = {
                            {% if intent != 'STORE' %}
                            amount: '{{ amount }}', // Amount as a string
                            {% endif %}
                            currencyCode: '{{ currency }}',
                            intent: '{{ intent }}',
                            customerInitiated: true,
                            sellerKeyedIn: false,
                            billingContact: {
                                addressLines: ['{{ address_line_1 }}'{% if address_line_2 %},'{{ address_line_2 }}'{% endif %}],
                                familyName: '{{ family_name }}',
                                givenName: '{{ given_name }}',
                                email: '{{ email }}',
                                phone: '{{ phone }}',
                                city: '{{ city }}',
                                state: '{{ state }}',
                                postalCode: '{{ postal_code }}',
                                countryCode: '{{ country_code }}',
                            },
                        };
                        
                        const verificationResult = await payments.verifyBuyer(result.token, verificationDetails);
                        
                        // 3. Send BOTH tokens to the PHP controller
                        $.ajax({
                            url: '{{ squareup_process_payment }}',
                            type: 'post',
                            data: { 
                                source_id: result.token,
                                verification_token: verificationResult.token // CRITICAL for STORE intent
                            },
                            dataType: 'json',
                            success: function(json) {
                                if (json['redirect']) {
                                    location = json['redirect'];	
                                }
                            },
                            error: function(xhr, ajaxOptions, thrownError) {
                                console.error(xhr.responseText);
                                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                                btn.disabled = false;
                            }
                        });
                    } else {
                        console.error(result.errors);
                        btn.disabled = false;
                    }
                } catch (e) {
                    console.error(e);
                    btn.disabled = false;
                }

            });
            console.log("Square initialized successfully");
        } catch (e) {
            console.error("Square initialization failed: ", e);
        }
    }

    // Poll for the 'Square' object instead of relying on DOM events
    // This works even if OpenCart loads this template via AJAX
    const checkSquareLoad = setInterval(() => {
        if (typeof Square !== 'undefined') {
            clearInterval(checkSquareLoad);
            initializeSquare();
        }
    }, 100); // Check every 100ms
})();

// Monitor script loading
window.addEventListener('error', function(e) {
    if (e.target.src && e.target.src.includes('square.js')) {
        console.error('Square script failed to load:', e);
        handleScriptLoadError();
    }
});

function handleScriptLoadError() {
	alert("Payment temporarily unavailable. Please try again later.");
}

</script>
